<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Dynamic File Serving With Embedded File System and Object Storage in Go File Serving With Embedded File System and Object Storage in Go | Tim Engle Blog</title>
<meta name=keywords content><meta name=description content="Introduction
The references to a blog in this post are for my older blog that was built from
scratch using Go. My new blog is built using Hugo and the Papermod.
In my current project, this blog, I have a folder of static files embedded directly into the server’s binary. While this is nice to have, I am concerned with scaling, so I would also like to keep these static files in an object storage container like an S3 bucket."><meta name=author content="Tim Engle"><link rel=canonical href=https://timengle.dev/posts/dynamic-file-serving-with-embedded-file-system-and-object-storage-in-go-file-serving-with-embedded-file-system-and-object-storage-in-go/><link crossorigin=anonymous href=/assets/css/stylesheet.45e028aa8ce0961349adf411b013ee39406be2c0bc80d4ea3fc04555f7f4611a.css integrity="sha256-ReAoqozglhNJrfQRsBPuOUBr4sC8gNTqP8BFVff0YRo=" rel="preload stylesheet" as=style><link rel=icon href=https://timengle.dev/%3Clink%20/%20abs%20url%3E><link rel=icon type=image/png sizes=16x16 href=https://timengle.dev/%3Clink%20/%20abs%20url%3E><link rel=icon type=image/png sizes=32x32 href=https://timengle.dev/%3Clink%20/%20abs%20url%3E><link rel=apple-touch-icon href=https://timengle.dev/%3Clink%20/%20abs%20url%3E><link rel=mask-icon href=https://timengle.dev/%3Clink%20/%20abs%20url%3E><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://timengle.dev/posts/dynamic-file-serving-with-embedded-file-system-and-object-storage-in-go-file-serving-with-embedded-file-system-and-object-storage-in-go/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:url" content="https://timengle.dev/posts/dynamic-file-serving-with-embedded-file-system-and-object-storage-in-go-file-serving-with-embedded-file-system-and-object-storage-in-go/"><meta property="og:site_name" content="Tim Engle Blog"><meta property="og:title" content="Dynamic File Serving With Embedded File System and Object Storage in Go File Serving With Embedded File System and Object Storage in Go"><meta property="og:description" content="Introduction The references to a blog in this post are for my older blog that was built from scratch using Go. My new blog is built using Hugo and the Papermod.
In my current project, this blog, I have a folder of static files embedded directly into the server’s binary. While this is nice to have, I am concerned with scaling, so I would also like to keep these static files in an object storage container like an S3 bucket."><meta property="og:locale" content="en-us"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-08-14T20:36:36-08:00"><meta property="article:modified_time" content="2024-08-14T20:36:36-08:00"><meta property="og:image" content="https://timengle.dev/img/card.webp"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://timengle.dev/img/card.webp"><meta name=twitter:title content="Dynamic File Serving With Embedded File System and Object Storage in Go File Serving With Embedded File System and Object Storage in Go"><meta name=twitter:description content="Introduction
The references to a blog in this post are for my older blog that was built from
scratch using Go. My new blog is built using Hugo and the Papermod.
In my current project, this blog, I have a folder of static files embedded directly into the server’s binary. While this is nice to have, I am concerned with scaling, so I would also like to keep these static files in an object storage container like an S3 bucket."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://timengle.dev/posts/"},{"@type":"ListItem","position":2,"name":"Dynamic File Serving With Embedded File System and Object Storage in Go File Serving With Embedded File System and Object Storage in Go","item":"https://timengle.dev/posts/dynamic-file-serving-with-embedded-file-system-and-object-storage-in-go-file-serving-with-embedded-file-system-and-object-storage-in-go/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Dynamic File Serving With Embedded File System and Object Storage in Go File Serving With Embedded File System and Object Storage in Go","name":"Dynamic File Serving With Embedded File System and Object Storage in Go File Serving With Embedded File System and Object Storage in Go","description":"Introduction The references to a blog in this post are for my older blog that was built from scratch using Go. My new blog is built using Hugo and the Papermod.\nIn my current project, this blog, I have a folder of static files embedded directly into the server’s binary. While this is nice to have, I am concerned with scaling, so I would also like to keep these static files in an object storage container like an S3 bucket.\n","keywords":[],"articleBody":"Introduction The references to a blog in this post are for my older blog that was built from scratch using Go. My new blog is built using Hugo and the Papermod.\nIn my current project, this blog, I have a folder of static files embedded directly into the server’s binary. While this is nice to have, I am concerned with scaling, so I would also like to keep these static files in an object storage container like an S3 bucket.\nSince these files will be stored in two separate places, I need to create a Go interface that allows my application to switch between these storage types based on a runtime flag.\nWhat is Needed An interface that I can use to point to the locations of my static files. A flag to direct my program to where it should obtain my static files from. A URL for my object storage location and embedded static files. An environment variable to store the URL of my object storage. The Static Files Within the head element of each of my pages are some static files like\nLogo images Stylesheets JavaScript files The goal is to be able to load the static files either the embedded file system or an Object Storage location.\nEmbedded File System: /static/dist Cloud Storage: https://mybucketlocation.com/static/disto This will be possible by redirecting requests to either use the embedded file system or the object storage whenever a GET request is made to /static/.\nStatic file URLs have the following format.\n\"/static/some/path/static.file\" The Plan 1. Create a flag to to toggle between embedded and object storage based serving In the main.go file there is a config struct which has been assigned to cfg where the application will store if the object storage should be used. This config struct is included in our application struct which handles the state of our application.\nIf serveStaticObjectStorage is set to true an environment variable named objectStorageURL will be validated and set to the cfg.\ntype application struct { //... cfg *config //... } type config struct { //... objectStorage objectStorageConfig //... } type objectStorageConfig struct { objectStorageURL string serveStaticObjectStorage bool } func main() { var cfg config //... // Check flags flag.BoolVar(\u0026cfg.objectStorage.serveStaticObjectStorage, \"object-storage\", false, \"Serve static files from object storage\") flag.Parse() // Validate Object Storage URL if cfg.objectStorage.serveStaticObjectStorage { osURL := os.Getenv(\"OBJECT_STORAGE_URL\") if osURL == \"\" { log.Fatal(\"OBJECT_STORAGE_URL must be set when object storage is enabled\") } targetFile := fmt.Sprintf(\"%s/static/dist/js/form-prevent.js\", osURL) resp, err := http.Get(targetFile) if err != nil { log.Fatal(\"Unable to connect to object storage\") } if resp.StatusCode != http.StatusOK { log.Fatal(\"Unable to connect to object storage\") } cfg.objectStorage.objectStorageURL = osURL } //... // Further into the main function the application // assigns `cfg` to an application struct. } 2. Abstract the FileServer Logic Currently, static files are being served from by a Handler returned from the FileServerFS function. The logic needs to be abstracted by creating a custom FileServer interface which can be used for two types EmbeddedFileServer and ObjectStorageFileServer which I will create.\ntype FileServer interface { ServeHTTP(w http.ResponseWriter, r *http.Request) } Now that I have created the FileServer interface I can create my two types and their ServeHTTP method to satisfy the interface.\nEmbeddedFileServer // internal/fileserver/embedded.go type EmbeddedFileServer struct { FS http.FileSystem } func (efs *EmbeddedFileServer) ServeHTTP(w http.ResponseWriter, r *http.Request) { http.FileServer(efs.FS).ServeHTTP(w, r) } ObjectStorageFileServer // internal/fileserver/object_storage.go type ObjectStorageFileServer struct { objectStorageURL string } func (osfs *ObjectStorageFileServer) ServeHTTP(w http.ResponseWriter, r *http.Request){ fileURL := fmt.Sprintf(\"%s%s\", osfs.objectStorageURL, r.URL.Path) http.Redirect(w, r, fileURL, http.StatusFound) } Now that the new types have been created and both satisfy the interface they can be implemented into the router.\n3. Update the Router Router Update The router is currently serving the embedded static files with the following code\nfunc (app *application) router { mux := http.NewServeMux() fileServer := http.FileServerFS(ui.Files) mux.Handle(\"/static/\", fileServer) // ... } Now static files can be served from either the embedded file system or object storage by checking if the serveStaticObjectStorage is true or false.\nfunc (app *application) router { mux := http.NewServeMux() var fileSvr http.Handler if app.cfg.objectStorage.serveStaticObjectStorage { fileSvr = \u0026fileserver.ObjectStorageFileServer{ObjectStorageURL: app.cfg.objectStorage.objectStorageURL} } else { fileSvr = \u0026fileserver.EmbeddedFileServer{FS: http.FS(ui.Files)} } mux.Handle(\"/static/\", fileSvr) // ... } Conclusion With this setup, my blog is now flexible enough to serve static files from either an embedded file system or an object storage service, depending on the needs at runtime. This approach makes it easier to scale and adapt the application as it grows, whether it’s to handle more traffic or to streamline deployments. By simply flipping a flag, I can switch between these storage options, ensuring my blog remains both efficient and ready for future expansions. As I continue to iterate on this blog, I’ll keep exploring ways to enhance its performance and scalability, ensuring that it remains both maintainable and future-proof.\n","wordCount":"794","inLanguage":"en","image":"https://timengle.dev/img/card.webp","datePublished":"2024-08-14T20:36:36-08:00","dateModified":"2024-08-14T20:36:36-08:00","author":{"@type":"Person","name":"Tim Engle"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://timengle.dev/posts/dynamic-file-serving-with-embedded-file-system-and-object-storage-in-go-file-serving-with-embedded-file-system-and-object-storage-in-go/"},"publisher":{"@type":"Organization","name":"Tim Engle Blog","logo":{"@type":"ImageObject","url":"https://timengle.dev/%3Clink%20/%20abs%20url%3E"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://timengle.dev/ accesskey=h title="Home (Alt + H)"><img src=https://timengle.dev/apple-touch-icon.png alt aria-label=logo height=35>Home</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://timengle.dev/>Home</a>&nbsp;»&nbsp;<a href=https://timengle.dev/posts/>Posts</a></div><h1 class="post-title entry-hint-parent">Dynamic File Serving With Embedded File System and Object Storage in Go File Serving With Embedded File System and Object Storage in Go</h1><div class=post-meta><span title='2024-08-14 20:36:36 -0800 -0800'>August 14, 2024</span>&nbsp;·&nbsp;4 min&nbsp;·&nbsp;794 words&nbsp;·&nbsp;Tim Engle</div></header><div class=post-content><h2 id=introduction>Introduction<a hidden class=anchor aria-hidden=true href=#introduction>#</a></h2><p><em>The references to a blog in this post are for my older blog that was built from
scratch using Go. My new blog is built using Hugo and the Papermod.</em></p><p>In my current project, this blog, I have a folder of static files embedded directly into the server’s binary. While this is nice to have, I am concerned with scaling, so I would also like to keep these static files in an object storage container like an S3 bucket.</p><p>Since these files will be stored in two separate places, I need to create a Go interface that allows my application to switch between these storage types based on a runtime flag.</p><hr><h2 id=what-is-needed>What is Needed<a hidden class=anchor aria-hidden=true href=#what-is-needed>#</a></h2><ul><li>An interface that I can use to point to the locations of my static files.</li><li>A flag to direct my program to where it should obtain my static files from.</li><li>A URL for my object storage location and embedded static files.</li><li>An environment variable to store the URL of my object storage.</li></ul><h2 id=the-static-files>The Static Files<a hidden class=anchor aria-hidden=true href=#the-static-files>#</a></h2><p>Within the <code>head</code> element of each of my pages are some static files like</p><ul><li>Logo images</li><li>Stylesheets</li><li>JavaScript files</li></ul><p>The goal is to be able to load the static files either the embedded file system or an Object Storage location.</p><ul><li>Embedded File System: <code>/static/dist</code></li><li>Cloud Storage: <code>https://mybucketlocation.com/static/dist</code>o</li></ul><p>This will be possible by redirecting requests to either use the embedded file system or the object storage whenever a GET request is made to <code>/static/</code>.</p><p>Static file URLs have the following format.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>&#34;/static/some/path/static.file&#34;
</span></span></code></pre></div><hr><h1 id=the-plan>The Plan<a hidden class=anchor aria-hidden=true href=#the-plan>#</a></h1><h2 id=1-create-a-flag-to-to-toggle-between-embedded-and-object-storage-based-serving>1. Create a flag to to toggle between embedded and object storage based serving<a hidden class=anchor aria-hidden=true href=#1-create-a-flag-to-to-toggle-between-embedded-and-object-storage-based-serving>#</a></h2><p>In the <code>main.go</code> file there is a <code>config</code> struct which has been assigned to <code>cfg</code> where the application will store if the object storage should be used. This config struct is included in our <code>application</code> struct which handles the state of our application.</p><p>If <code>serveStaticObjectStorage</code> is set to true an environment variable named <code>objectStorageURL</code> will be validated and set to the <code>cfg</code>.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>application</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl> <span class=c1>//...
</span></span></span><span class=line><span class=cl><span class=c1></span> <span class=nx>cfg</span>               <span class=o>*</span><span class=nx>config</span>
</span></span><span class=line><span class=cl> <span class=c1>//...
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>type</span> <span class=nx>config</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl> <span class=c1>//...
</span></span></span><span class=line><span class=cl><span class=c1></span> <span class=nx>objectStorage</span> <span class=nx>objectStorageConfig</span>
</span></span><span class=line><span class=cl> <span class=c1>//...
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>type</span> <span class=nx>objectStorageConfig</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl> <span class=nx>objectStorageURL</span>         <span class=kt>string</span>
</span></span><span class=line><span class=cl> <span class=nx>serveStaticObjectStorage</span> <span class=kt>bool</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl> <span class=kd>var</span> <span class=nx>cfg</span> <span class=nx>config</span>
</span></span><span class=line><span class=cl> <span class=c1>//...
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl> <span class=c1>// Check flags
</span></span></span><span class=line><span class=cl><span class=c1></span> <span class=nx>flag</span><span class=p>.</span><span class=nf>BoolVar</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>cfg</span><span class=p>.</span><span class=nx>objectStorage</span><span class=p>.</span><span class=nx>serveStaticObjectStorage</span><span class=p>,</span> <span class=s>&#34;object-storage&#34;</span><span class=p>,</span> <span class=kc>false</span><span class=p>,</span> <span class=s>&#34;Serve static files from object storage&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl> <span class=nx>flag</span><span class=p>.</span><span class=nf>Parse</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl> <span class=c1>// Validate Object Storage URL
</span></span></span><span class=line><span class=cl><span class=c1></span> <span class=k>if</span> <span class=nx>cfg</span><span class=p>.</span><span class=nx>objectStorage</span><span class=p>.</span><span class=nx>serveStaticObjectStorage</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>osURL</span> <span class=o>:=</span> <span class=nx>os</span><span class=p>.</span><span class=nf>Getenv</span><span class=p>(</span><span class=s>&#34;OBJECT_STORAGE_URL&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=nx>osURL</span> <span class=o>==</span> <span class=s>&#34;&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>   <span class=nx>log</span><span class=p>.</span><span class=nf>Fatal</span><span class=p>(</span><span class=s>&#34;OBJECT_STORAGE_URL must be set when object storage is enabled&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=nx>targetFile</span> <span class=o>:=</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Sprintf</span><span class=p>(</span><span class=s>&#34;%s/static/dist/js/form-prevent.js&#34;</span><span class=p>,</span> <span class=nx>osURL</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=nx>resp</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>http</span><span class=p>.</span><span class=nf>Get</span><span class=p>(</span><span class=nx>targetFile</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>   <span class=nx>log</span><span class=p>.</span><span class=nf>Fatal</span><span class=p>(</span><span class=s>&#34;Unable to connect to object storage&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=nx>resp</span><span class=p>.</span><span class=nx>StatusCode</span> <span class=o>!=</span> <span class=nx>http</span><span class=p>.</span><span class=nx>StatusOK</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>   <span class=nx>log</span><span class=p>.</span><span class=nf>Fatal</span><span class=p>(</span><span class=s>&#34;Unable to connect to object storage&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=nx>cfg</span><span class=p>.</span><span class=nx>objectStorage</span><span class=p>.</span><span class=nx>objectStorageURL</span> <span class=p>=</span> <span class=nx>osURL</span>
</span></span><span class=line><span class=cl> <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl> <span class=c1>//...
</span></span></span><span class=line><span class=cl><span class=c1></span> <span class=c1>// Further into the main function the application
</span></span></span><span class=line><span class=cl><span class=c1></span> <span class=c1>// assigns `cfg` to an application struct.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span></code></pre></div><h2 id=2-abstract-the-fileserver-logic>2. Abstract the FileServer Logic<a hidden class=anchor aria-hidden=true href=#2-abstract-the-fileserver-logic>#</a></h2><p>Currently, static files are being served from by a <a href=https://pkg.go.dev/net/http#Handler>Handler</a> returned from the <a href=https://pkg.go.dev/net/http#FileServerFS>FileServerFS</a> function. The logic needs to be abstracted by creating a custom <code>FileServer</code> interface which can be used for two types <code>EmbeddedFileServer</code> and <code>ObjectStorageFileServer</code> which I will create.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>FileServer</span> <span class=kd>interface</span> <span class=p>{</span>
</span></span><span class=line><span class=cl> <span class=nf>ServeHTTP</span><span class=p>(</span><span class=nx>w</span> <span class=nx>http</span><span class=p>.</span><span class=nx>ResponseWriter</span><span class=p>,</span> <span class=nx>r</span> <span class=o>*</span><span class=nx>http</span><span class=p>.</span><span class=nx>Request</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>Now that I have created the <code>FileServer</code> interface I can create my two types and their <code>ServeHTTP</code> method to satisfy the interface.</p><h3 id=embeddedfileserver>EmbeddedFileServer<a hidden class=anchor aria-hidden=true href=#embeddedfileserver>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// internal/fileserver/embedded.go
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=kd>type</span> <span class=nx>EmbeddedFileServer</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl> <span class=nx>FS</span> <span class=nx>http</span><span class=p>.</span><span class=nx>FileSystem</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>efs</span> <span class=o>*</span><span class=nx>EmbeddedFileServer</span><span class=p>)</span> <span class=nf>ServeHTTP</span><span class=p>(</span><span class=nx>w</span> <span class=nx>http</span><span class=p>.</span><span class=nx>ResponseWriter</span><span class=p>,</span> <span class=nx>r</span> <span class=o>*</span><span class=nx>http</span><span class=p>.</span><span class=nx>Request</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl> <span class=nx>http</span><span class=p>.</span><span class=nf>FileServer</span><span class=p>(</span><span class=nx>efs</span><span class=p>.</span><span class=nx>FS</span><span class=p>).</span><span class=nf>ServeHTTP</span><span class=p>(</span><span class=nx>w</span><span class=p>,</span> <span class=nx>r</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h3 id=objectstoragefileserver>ObjectStorageFileServer<a hidden class=anchor aria-hidden=true href=#objectstoragefileserver>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// internal/fileserver/object_storage.go
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>type</span> <span class=nx>ObjectStorageFileServer</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl> <span class=nx>objectStorageURL</span> <span class=kt>string</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>osfs</span> <span class=o>*</span><span class=nx>ObjectStorageFileServer</span><span class=p>)</span> <span class=nf>ServeHTTP</span><span class=p>(</span><span class=nx>w</span> <span class=nx>http</span><span class=p>.</span><span class=nx>ResponseWriter</span><span class=p>,</span> <span class=nx>r</span> <span class=o>*</span><span class=nx>http</span><span class=p>.</span><span class=nx>Request</span><span class=p>){</span>
</span></span><span class=line><span class=cl> <span class=nx>fileURL</span> <span class=o>:=</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Sprintf</span><span class=p>(</span><span class=s>&#34;%s%s&#34;</span><span class=p>,</span> <span class=nx>osfs</span><span class=p>.</span><span class=nx>objectStorageURL</span><span class=p>,</span> <span class=nx>r</span><span class=p>.</span><span class=nx>URL</span><span class=p>.</span><span class=nx>Path</span><span class=p>)</span>
</span></span><span class=line><span class=cl> <span class=nx>http</span><span class=p>.</span><span class=nf>Redirect</span><span class=p>(</span><span class=nx>w</span><span class=p>,</span> <span class=nx>r</span><span class=p>,</span> <span class=nx>fileURL</span><span class=p>,</span> <span class=nx>http</span><span class=p>.</span><span class=nx>StatusFound</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>Now that the new types have been created and both satisfy the interface they can be implemented into the router.</p><h2 id=3-update-the-router>3. Update the Router<a hidden class=anchor aria-hidden=true href=#3-update-the-router>#</a></h2><h3 id=router-update>Router Update<a hidden class=anchor aria-hidden=true href=#router-update>#</a></h3><p>The router is currently serving the embedded static files with the following code</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>app</span> <span class=o>*</span><span class=nx>application</span><span class=p>)</span> <span class=nx>router</span> <span class=p>{</span>
</span></span><span class=line><span class=cl> <span class=nx>mux</span> <span class=o>:=</span> <span class=nx>http</span><span class=p>.</span><span class=nf>NewServeMux</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl> <span class=nx>fileServer</span> <span class=o>:=</span> <span class=nx>http</span><span class=p>.</span><span class=nf>FileServerFS</span><span class=p>(</span><span class=nx>ui</span><span class=p>.</span><span class=nx>Files</span><span class=p>)</span>
</span></span><span class=line><span class=cl> <span class=nx>mux</span><span class=p>.</span><span class=nf>Handle</span><span class=p>(</span><span class=s>&#34;/static/&#34;</span><span class=p>,</span> <span class=nx>fileServer</span><span class=p>)</span>
</span></span><span class=line><span class=cl> <span class=c1>// ...
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span></code></pre></div><p>Now static files can be served from either the embedded file system or object storage by checking if the <code>serveStaticObjectStorage</code> is true or false.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>app</span> <span class=o>*</span><span class=nx>application</span><span class=p>)</span> <span class=nx>router</span> <span class=p>{</span>
</span></span><span class=line><span class=cl> <span class=nx>mux</span> <span class=o>:=</span> <span class=nx>http</span><span class=p>.</span><span class=nf>NewServeMux</span><span class=p>()</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl> <span class=kd>var</span> <span class=nx>fileSvr</span> <span class=nx>http</span><span class=p>.</span><span class=nx>Handler</span>
</span></span><span class=line><span class=cl> <span class=k>if</span> <span class=nx>app</span><span class=p>.</span><span class=nx>cfg</span><span class=p>.</span><span class=nx>objectStorage</span><span class=p>.</span><span class=nx>serveStaticObjectStorage</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>fileSvr</span> <span class=p>=</span> <span class=o>&amp;</span><span class=nx>fileserver</span><span class=p>.</span><span class=nx>ObjectStorageFileServer</span><span class=p>{</span><span class=nx>ObjectStorageURL</span><span class=p>:</span> <span class=nx>app</span><span class=p>.</span><span class=nx>cfg</span><span class=p>.</span><span class=nx>objectStorage</span><span class=p>.</span><span class=nx>objectStorageURL</span><span class=p>}</span>
</span></span><span class=line><span class=cl> <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>fileSvr</span> <span class=p>=</span> <span class=o>&amp;</span><span class=nx>fileserver</span><span class=p>.</span><span class=nx>EmbeddedFileServer</span><span class=p>{</span><span class=nx>FS</span><span class=p>:</span> <span class=nx>http</span><span class=p>.</span><span class=nf>FS</span><span class=p>(</span><span class=nx>ui</span><span class=p>.</span><span class=nx>Files</span><span class=p>)}</span>
</span></span><span class=line><span class=cl> <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl> <span class=nx>mux</span><span class=p>.</span><span class=nf>Handle</span><span class=p>(</span><span class=s>&#34;/static/&#34;</span><span class=p>,</span> <span class=nx>fileSvr</span><span class=p>)</span>
</span></span><span class=line><span class=cl> <span class=c1>// ...
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span></code></pre></div><hr><h1 id=conclusion>Conclusion<a hidden class=anchor aria-hidden=true href=#conclusion>#</a></h1><p>With this setup, my blog is now flexible enough to serve static files from either an embedded file system or an object storage service, depending on the needs at runtime. This approach makes it easier to scale and adapt the application as it grows, whether it’s to handle more traffic or to streamline deployments. By simply flipping a flag, I can switch between these storage options, ensuring my blog remains both efficient and ready for future expansions. As I continue to iterate on this blog, I&rsquo;ll keep exploring ways to enhance its performance and scalability, ensuring that it remains both maintainable and future-proof.</p></div><footer class=post-footer><ul class=post-tags></ul><nav class=paginav><a class=prev href=https://timengle.dev/posts/a-simple-guide-to-name-resolution/><span class=title>« Prev</span><br><span>A Simple Guide to Name Resolution</span></a></nav><ul class=share-buttons><li><a target=_blank rel="noopener noreferrer" aria-label="share Dynamic File Serving With Embedded File System and Object Storage in Go File Serving With Embedded File System and Object Storage in Go on x" href="https://x.com/intent/tweet/?text=Dynamic%20File%20Serving%20With%20Embedded%20File%20System%20and%20Object%20Storage%20in%20Go%20File%20Serving%20With%20Embedded%20File%20System%20and%20Object%20Storage%20in%20Go&amp;url=https%3a%2f%2ftimengle.dev%2fposts%2fdynamic-file-serving-with-embedded-file-system-and-object-storage-in-go-file-serving-with-embedded-file-system-and-object-storage-in-go%2f&amp;hashtags="><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446C483.971.0 512 28.03 512 62.554zM269.951 190.75 182.567 75.216H56L207.216 272.95 63.9 436.783h61.366L235.9 310.383l96.667 126.4H456L298.367 228.367l134-153.151H371.033zM127.633 110h36.468l219.38 290.065H349.5z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Dynamic File Serving With Embedded File System and Object Storage in Go File Serving With Embedded File System and Object Storage in Go on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2ftimengle.dev%2fposts%2fdynamic-file-serving-with-embedded-file-system-and-object-storage-in-go-file-serving-with-embedded-file-system-and-object-storage-in-go%2f&amp;title=Dynamic%20File%20Serving%20With%20Embedded%20File%20System%20and%20Object%20Storage%20in%20Go%20File%20Serving%20With%20Embedded%20File%20System%20and%20Object%20Storage%20in%20Go&amp;summary=Dynamic%20File%20Serving%20With%20Embedded%20File%20System%20and%20Object%20Storage%20in%20Go%20File%20Serving%20With%20Embedded%20File%20System%20and%20Object%20Storage%20in%20Go&amp;source=https%3a%2f%2ftimengle.dev%2fposts%2fdynamic-file-serving-with-embedded-file-system-and-object-storage-in-go-file-serving-with-embedded-file-system-and-object-storage-in-go%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Dynamic File Serving With Embedded File System and Object Storage in Go File Serving With Embedded File System and Object Storage in Go on reddit" href="https://reddit.com/submit?url=https%3a%2f%2ftimengle.dev%2fposts%2fdynamic-file-serving-with-embedded-file-system-and-object-storage-in-go-file-serving-with-embedded-file-system-and-object-storage-in-go%2f&title=Dynamic%20File%20Serving%20With%20Embedded%20File%20System%20and%20Object%20Storage%20in%20Go%20File%20Serving%20With%20Embedded%20File%20System%20and%20Object%20Storage%20in%20Go"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Dynamic File Serving With Embedded File System and Object Storage in Go File Serving With Embedded File System and Object Storage in Go on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2ftimengle.dev%2fposts%2fdynamic-file-serving-with-embedded-file-system-and-object-storage-in-go-file-serving-with-embedded-file-system-and-object-storage-in-go%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Dynamic File Serving With Embedded File System and Object Storage in Go File Serving With Embedded File System and Object Storage in Go on whatsapp" href="https://api.whatsapp.com/send?text=Dynamic%20File%20Serving%20With%20Embedded%20File%20System%20and%20Object%20Storage%20in%20Go%20File%20Serving%20With%20Embedded%20File%20System%20and%20Object%20Storage%20in%20Go%20-%20https%3a%2f%2ftimengle.dev%2fposts%2fdynamic-file-serving-with-embedded-file-system-and-object-storage-in-go-file-serving-with-embedded-file-system-and-object-storage-in-go%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Dynamic File Serving With Embedded File System and Object Storage in Go File Serving With Embedded File System and Object Storage in Go on telegram" href="https://telegram.me/share/url?text=Dynamic%20File%20Serving%20With%20Embedded%20File%20System%20and%20Object%20Storage%20in%20Go%20File%20Serving%20With%20Embedded%20File%20System%20and%20Object%20Storage%20in%20Go&amp;url=https%3a%2f%2ftimengle.dev%2fposts%2fdynamic-file-serving-with-embedded-file-system-and-object-storage-in-go-file-serving-with-embedded-file-system-and-object-storage-in-go%2f"><svg viewBox="2 2 28 28" height="30" width="30" fill="currentcolor"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Dynamic File Serving With Embedded File System and Object Storage in Go File Serving With Embedded File System and Object Storage in Go on ycombinator" href="https://news.ycombinator.com/submitlink?t=Dynamic%20File%20Serving%20With%20Embedded%20File%20System%20and%20Object%20Storage%20in%20Go%20File%20Serving%20With%20Embedded%20File%20System%20and%20Object%20Storage%20in%20Go&u=https%3a%2f%2ftimengle.dev%2fposts%2fdynamic-file-serving-with-embedded-file-system-and-object-storage-in-go-file-serving-with-embedded-file-system-and-object-storage-in-go%2f"><svg width="30" height="30" viewBox="0 0 512 512" fill="currentcolor" xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape"><path d="M449.446.0C483.971.0 512 28.03 512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446zM183.8767 87.9921h-62.034L230.6673 292.4508V424.0079h50.6655V292.4508L390.1575 87.9921H328.1233L256 238.2489z"/></svg></a></li></ul></footer></article></main><footer class=footer><span>&copy; 2025 <a href=https://timengle.dev/>Tim Engle Blog</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>